# Custom Triton image with TensorRT-LLM + Python dependencies
FROM nvcr.io/nvidia/tritonserver:25.12-trtllm-python-py3

# Install system dependencies
RUN apt-get update && apt-get install -y --no-install-recommends \
        espeak-ng \
        libsndfile1 \
    && rm -rf /var/lib/apt/lists/*

# Get torch version from base image, install matching torchaudio/torchvision
# Then create constraints to prevent ANY package from changing torch versions
RUN TORCH_VERSION=$(pip show torch | grep Version | cut -d' ' -f2) && \
    CUDA_VERSION=$(python3 -c "import torch; print(torch.version.cuda.replace('.', '')[:3])") && \
    echo "Base image: torch==${TORCH_VERSION} CUDA=${CUDA_VERSION}" && \
    pip install --no-cache-dir --no-deps \
        torchaudio torchvision \
        --index-url https://download.pytorch.org/whl/cu${CUDA_VERSION} && \
    echo "torch==${TORCH_VERSION}" > /tmp/constraints.txt && \
    echo "torchaudio==$(pip show torchaudio | grep Version | cut -d' ' -f2)" >> /tmp/constraints.txt && \
    echo "torchvision==$(pip show torchvision | grep Version | cut -d' ' -f2)" >> /tmp/constraints.txt && \
    cat /tmp/constraints.txt

# Install grpcio binary
RUN pip install --no-cache-dir --only-binary :all: grpcio grpcio-tools

# Install all dependencies
RUN pip install --no-cache-dir -c /tmp/constraints.txt \
        "transformers>=4.40.0" \
        sentencepiece einops \
        diffusers x-transformers conformer \
        hydra-core omegaconf hyperpyyaml pydantic \
        librosa soundfile pyworld phonemizer inflect Unidecode \
        sherpa-onnx onnxruntime-gpu \
        "s3tokenizer==0.1.5" \
        onnx wget gdown

# Install matcha-tts (required by CosyVoice flow_matching)
RUN pip install --no-cache-dir -c /tmp/constraints.txt \
        git+https://github.com/shivammehta25/Matcha-TTS.git
